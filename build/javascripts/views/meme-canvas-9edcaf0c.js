MEME.MemeCanvasView=Backbone.View.extend({initialize:function(){var t=document.createElement("canvas"),e=MEME.$("#meme-canvas");t&&t.getContext?(e.html(t),this.canvas=t,this.setDownload(),this.render()):e.html(this.$("noscript").html()),this.listenTo(this.model,"change",this.render)},setDownload:function(){var t=document.createElement("a");"undefined"==typeof t.download&&this.$el.append('<p class="m-canvas__download-note">Right-click button and select "Download Linked File..." to save image.</p>')},render:function(){function t(t){var e=h.background.height,a=h.background.width;if(e&&a){var i=e*l.imageScale,n=a*l.imageScale,o=l.backgroundPosition.x||l.width/2,r=l.backgroundPosition.y||l.height/2;t.drawImage(h.background,0,0,a,e,o-n/2,r-i/2,n,i)}}function e(t){return h.background.height>0?!1:void(l.backgroundColor&&(t.fillStyle=l.backgroundColor,t.fillRect(0,0,l.width,l.height)))}function a(t){l.overlayColor&&(t.save(),t.globalAlpha=l.overlayAlpha,t.fillStyle=l.overlayColor,t.fillRect(0,0,l.width,l.height),t.globalAlpha=1,t.restore())}function i(t){var e=Math.round(.75*l.width),a=d,i=d;t.font=l.fontSize+"pt "+l.fontFamily,t.fillStyle=l.fontColor,t.textBaseline="top",l.textShadow&&(t.shadowColor="#666",t.shadowOffsetX=-2,t.shadowOffsetY=1,t.shadowBlur=10),"center"==l.textAlign?(t.textAlign="center",a=l.width/2,i=l.height-l.height/1.75,e=l.width-l.width/3):"right"==l.textAlign?(t.textAlign="right",a=l.width-d):t.textAlign="left";var n=1.5,o=l.headlineText.split(" "),h=/\r|\n/,r=[];_.each(o,function(t){if(h.exec(t)){var e=t.split(h);_.each(e,function(t,e){r.push(t),e%2==0&&r.push("\n")})}else r.push(t)});var r=_.filter(r,function(t){return""!=t}),s="";_.each(r,function(o,h){if("\n"==o)t.fillText(s,a,i),s="",i+=Math.round(l.fontSize*n);else{var r=s+o+" ",d=t.measureText(r),c=d.width;c>e&&h>0?(t.fillText(s,a,i),s=o+" ",i+=Math.round(l.fontSize*n)):s=r}}),t.fillText(s,a,i),t.shadowColor="transparent"}function n(t){t.textBaseline="bottom",t.textAlign="left",t.fillStyle=l.fontColor,t.font="normal 14pt Arial",t.fillText(l.creditText,d,l.height-d)}function o(t){var e,a,i,n;if(a=n=h.watermark.height,e=i=h.watermark.width,a&&e){var o=l.width*l.watermarkMaxWidthRatio;e>o&&(n=a*(o/e),i=o),t.globalAlpha=l.watermarkAlpha,t.drawImage(h.watermark,0,0,e,a,l.width-d-i,l.height-d-n,i,n),t.globalAlpha=1}}if(this.canvas){var h=this.model,l=this.model.toJSON(),r=this.canvas.getContext("2d"),d=Math.round(l.width*l.paddingRatio);this.canvas.width=l.width,this.canvas.height=l.height,r.clearRect(0,0,l.width,l.height),t(r),e(r),a(r),i(r),n(r),o(r);var s=this.canvas.toDataURL();this.$("#meme-download").attr({href:s,download:(l.downloadName||"share")+".png"}),this.canvas.style.cursor=this.model.background.width?"move":"default"}},events:{"mousedown canvas":"onDrag"},onDrag:function(t){function e(t){t.preventDefault(),a.set("backgroundPosition",{x:Math.max(i.width-n,Math.min(l.x-(h.x-t.clientX),n)),y:Math.max(i.height-o,Math.min(l.y-(h.y-t.clientY),o))})}if(t.preventDefault(),this.model.hasBackground()){var a=this.model,i=a.toJSON(),n=a.background.width*i.imageScale/2,o=a.background.height*i.imageScale/2,h={x:t.clientX,y:t.clientY},l=i.backgroundPosition;l.x=l.x||i.width/2,l.y=l.y||i.height/2;var r=MEME.$(document).on("mousemove.drag",e).on("mouseup.drag",function(t){r.off("mouseup.drag mousemove.drag"),e(t)})}}});